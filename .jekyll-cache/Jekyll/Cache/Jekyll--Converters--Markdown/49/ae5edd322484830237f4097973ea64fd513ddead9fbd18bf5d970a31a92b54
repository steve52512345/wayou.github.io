I"[<h1 id="mysql-explicit_defaults_for_timestamp-与-timestamp">MySQL <code class="language-plaintext highlighter-rouge">explicit_defaults_for_timestamp</code> 与 TIMESTAMP</h1>

<p>考察下面的 SQL 脚本：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">test1</span><span class="p">(</span>
  <span class="n">id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="k">data</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
  <span class="n">ts1</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">createdAt</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
  <span class="n">updatedAt</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>
</code></pre></div></div>

<p>语义上来看，这里 <code class="language-plaintext highlighter-rouge">ts1</code> 列没有指定默认值，同时也没指定 <code class="language-plaintext highlighter-rouge">ON UPDATE</code> 的操作。</p>

<p>实际情况则不然，在 <code class="language-plaintext highlighter-rouge">explicit_defaults_for_timestamp</code> 关闭的情况下，<code class="language-plaintext highlighter-rouge">t1</code> 会被默认加上 <code class="language-plaintext highlighter-rouge">DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code>。这可通过 <code class="language-plaintext highlighter-rouge">DESCRIBE test1</code> 查看到。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; describe test1<span class="p">;</span>
+-----------+-------------+------+-----+-------------------+-----------------------------------------------+
| Field     | Type        | Null | Key | Default           | Extra                                         |
+-----------+-------------+------+-----+-------------------+-----------------------------------------------+
| <span class="nb">id</span>        | int<span class="o">(</span>11<span class="o">)</span>     | NO   | PRI | NULL              | auto_increment                                |
| data      | varchar<span class="o">(</span>20<span class="o">)</span> | YES  |     | NULL              |                                               |
| ts1       | timestamp   | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| createdAt | timestamp   | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt | timestamp   | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+-----------+-------------+------+-----+-------------------+-----------------------------------------------+
5 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre></div></div>

<h2 id="explicit_defaults_for_timestamp"><code class="language-plaintext highlighter-rouge">@@explicit_defaults_for_timestamp</code></h2>

<p><a href="https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_explicit_defaults_for_timestamp"><code class="language-plaintext highlighter-rouge">explicit_defaults_for_timestamp</code></a> 控制是否开启非标准模式下非法的日期值继续努力 NULL，零值等日期默认值被写入 TIMESTAMP 类型。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="k">select</span> @@explicit_defaults_for_timestamp<span class="p">;</span>
+-----------------------------------+
| @@explicit_defaults_for_timestamp |
+-----------------------------------+
|                                 1 |
+-----------------------------------+
1 row <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></div></div>

<p>可以看到默认为开，现在来关闭它：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span> @@explicit_defaults_for_timestamp<span class="o">=</span>0<span class="p">;</span>
</code></pre></div></div>

<details>
<summary>
关闭 `explicit_defaults_for_timestamp` 的执行结果
</summary>

```sh
mysql&gt; set @@explicit_defaults_for_timestamp=0;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql&gt; select @@explicit_defaults_for_timestamp;
+-----------------------------------+
| @@explicit_defaults_for_timestamp |
+-----------------------------------+
|                                 0 |
+-----------------------------------+
1 row in set (0.00 sec)
```
</details>

<p>此时便可以正常执行文章开头的 SQL 语句创建一个未指定默认值的 TIMESTAMP 列。</p>

<p>根据官方文档中相关描述：</p>

<blockquote>
  <p>TIMESTAMP and DATETIME columns have no automatic properties unless they are specified explicitly, with this exception: If the explicit_defaults_for_timestamp system variable is disabled, the first TIMESTAMP column has both DEFAULT CURRENT_TIMESTAMP and ON UPDATE CURRENT_TIMESTAMP if neither is specified explicitly.</p>

  <p><em>--<a href="https://dev.mysql.com/doc/refman/8.0/en/timestamp-initialization.html">11.3.4 Automatic Initialization and Updating for TIMESTAMP and DATETIME</a></em></p>
</blockquote>

<p>当且仅当表中第一个 <code class="language-plaintext highlighter-rouge">TIMESTAMP</code> 类型的列在没有指定默认值时，MySQL 会会其自动加上 <code class="language-plaintext highlighter-rouge">DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code>。这里 <code class="language-plaintext highlighter-rouge">ON UPDATE CURRENT_TIMESTAMP</code> 就需要小心了，如果你想保存的是一个确定性，它会在记录更新时自动更新这个日期，这就是我们表要的表现了。</p>

<p>所以对于 TIMESTAMP 类型，最好指定默认值，避免不可预知的表现。</p>

<h2 id="相关资源">相关资源</h2>

<ul>
  <li><a href="https://medium.com/@magnusjt/gotcha-timezones-in-nodejs-and-mysql-b39e418c9d3">Gotcha! Timezones in nodejs and mysql</a></li>
  <li><a href="https://dev.mysql.com/doc/refman/8.0/en/timestamp-initialization.html">11.3.4 Automatic Initialization and Updating for TIMESTAMP and DATETIME</a></li>
</ul>
:ET
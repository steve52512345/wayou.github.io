I"<h1 id="锁定项目的-node-版本">锁定项目的 node 版本</h1>

<p>一些老项目对 node 版本是有要求的，往往使用默认的新版本包安装不上，scripts 也跑不起来。</p>

<p>之前就遇到过运行一个小程序项目时，根据文档来，第一步安装就出错。本着办法总比问题多的理念，来一个解决一个。问题还真是一个接一个的出现。折腾头天，在解决一个包的运行问题时，发现切换到较低版本的 node 后一切安好。</p>

<p>所以，对于老项目，最好使用兼容性强的版本 8 或 10 的 LTS。</p>

<p>解决问题的根本方法是项目中要对 node 版本进行提示或锁死，否则新人仍会踩坑。</p>

<h2 id="nvmrc">.nvmrc</h2>

<p>在项目根目录添加 .nvmrc 文件可指定 nvm 默认的 node 版本。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node <span class="nt">-v</span> <span class="o">&gt;</span> .nvmrc
</code></pre></div></div>

<p>在执行 <code class="language-plaintext highlighter-rouge">nvm use</code>, <code class="language-plaintext highlighter-rouge">nvm install</code>, <code class="language-plaintext highlighter-rouge">nvm exec</code>, <code class="language-plaintext highlighter-rouge">nvm run</code> 或 <code class="language-plaintext highlighter-rouge">nvm which</code> 这些命令时，都会从该文件读取版本信息。</p>

<p>在新的环境下，clone 项目后通过 <code class="language-plaintext highlighter-rouge">nvm install &amp;&amp; nvm use</code> 就可使用上与项目相匹配的 node 版本。</p>

<h2 id="engines"><code class="language-plaintext highlighter-rouge">engines</code></h2>

<p>通过在 package.json 中指定 <code class="language-plaintext highlighter-rouge">engines</code> 字段，可限定项目使用的 node 版本，甚至 npm 版本。</p>

<p>不过，通常情况下，配置之后你会发现，该字段只对 yarn 生效：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ yarn
yarn install v1.22.5
info No lockfile found.
[1/5] 🔍  Validating package.json...
error test-node@1.0.0: The engine "node" is incompatible with this module. Expected version "&gt;=14". Got "10.22.0"
error Found incompatible module.
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
</code></pre></div></div>

<p>而使用 npm 进行安装时，直接成功没有提示，连 warnning 都没有：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i
npm WARN test-node@1.0.0 No description
npm WARN test-node@1.0.0 No repository field.

up to <span class="nb">date </span><span class="k">in </span>0.48s
found 0 vulnerabilities
</code></pre></div></div>

<p>根据 npm 文档中关于 <a href="https://docs.npmjs.com/files/package.json#engines"><code class="language-plaintext highlighter-rouge">engines</code></a> 的部分，发现要让 npm 识别 <code class="language-plaintext highlighter-rouge">engines</code> 字段，还需要配置 <code class="language-plaintext highlighter-rouge">engine-strict: true</code>，但是进一步看，</p>

<blockquote>
  <p>This feature was removed in npm 3.0.0</p>
</blockquote>

<p>王德发？</p>

<p>好消息是，进一步研究发现，创建 <code class="language-plaintext highlighter-rouge">.npmrc</code> 文件配置如下内容：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>engine-strict = true
</code></pre></div></div>

<p>就可以使得 <code class="language-plaintext highlighter-rouge">engines</code> 字段对 npm 生效了。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm i
npm ERR! code ENOTSUP
npm ERR! notsup Unsupported engine <span class="k">for </span>test-node@1.0.0: wanted: <span class="o">{</span><span class="s2">"node"</span>:<span class="s2">"&gt;=14"</span><span class="o">}</span> <span class="o">(</span>current: <span class="o">{</span><span class="s2">"node"</span>:<span class="s2">"10.22.0"</span>,<span class="s2">"npm"</span>:<span class="s2">"6.14.6"</span><span class="o">})</span>
npm ERR! notsup Not compatible with your version of node/npm: test-node@1.0.0
npm ERR! notsup Not compatible with your version of node/npm: test-node@1.0.0
npm ERR! notsup Required: <span class="o">{</span><span class="s2">"node"</span>:<span class="s2">"&gt;=14"</span><span class="o">}</span>
npm ERR! notsup Actual:   <span class="o">{</span><span class="s2">"npm"</span>:<span class="s2">"6.14.6"</span>,<span class="s2">"node"</span>:<span class="s2">"10.22.0"</span><span class="o">}</span>

npm ERR! A <span class="nb">complete </span>log of this run can be found <span class="k">in</span>:
npm ERR!     /Users/wayongliu/.npm/_logs/2020-09-14T13_43_33_020Z-debug.log
</code></pre></div></div>

<p>结合之前关于<a href="https://github.com/wayou/wayou.github.io/issues/229">项目中私有 npm 源的设置</a>，所以在项目中添加 <code class="language-plaintext highlighter-rouge">.npmrc</code> 真的是最佳实践了。</p>

<h2 id="相关资源">相关资源</h2>

<ul>
  <li><a href="https://github.com/nvm-sh/nvm#nvmrc">.nvmrc</a></li>
  <li><a href="https://docs.npmjs.com/files/package.json#engines">npm package.json engines</a></li>
  <li><a href="https://wawand.co/blog/posts/tip-ensuring-yarn/">TIP: Ensuring your team uses YARN/NPM</a></li>
</ul>
:ET